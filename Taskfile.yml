# Taskfile.yml
version: '3'

vars:
  # 2-day delay (security verification window)
  EXCLUDE_NEWER_DAYS: 2
  EXCLUDE_NEWER: "{{.EXCLUDE_NEWER_DAYS}} days"

tasks:
  uv:add:
    desc: "Add package (with {{.EXCLUDE_NEWER_DAYS}}-day delay)"
    cmds:
      - echo "Excluding packages newer than {{.EXCLUDE_NEWER}}"
      - uv add --exclude-newer "{{.EXCLUDE_NEWER}}" --no-build --no-install-project {{.CLI_ARGS}}
      - task: uv:export-requirements

  uv:lock:
    desc: "Lock dependencies (with {{.EXCLUDE_NEWER_DAYS}}-day delay)"
    cmds:
      - echo "Excluding packages newer than {{.EXCLUDE_NEWER}}"
      - uv lock --exclude-newer "{{.EXCLUDE_NEWER}}" --no-build
      - task: uv:export-requirements

  uv:lock:upgrade:
    desc: "Upgrade all dependencies (with {{.EXCLUDE_NEWER_DAYS}}-day delay)"
    cmds:
      - echo "Excluding packages newer than {{.EXCLUDE_NEWER}}"
      - uv lock --upgrade --exclude-newer "{{.EXCLUDE_NEWER}}" --no-build
      - task: uv:export-requirements

  uv:export-requirements:
    desc: "Export uv.lock to requirements.txt for scanners"
    cmds:
      - echo "Excluding packages newer than {{.EXCLUDE_NEWER_DATE}}"
      - uv export --format requirements.txt --all-groups --locked --exclude-newer {{.EXCLUDE_NEWER_DATE}} -o requirements.txt

  uv:sync:
    desc: "Sync environment"
    cmds:
      - uv sync --frozen --all-groups

  uv:run:
    desc: "Run command via uv with locked, time-delayed dependencies (e.g., task uv:run -- python app.py)"
    cmds:
      - uv run --no-sync {{.CLI_ARGS}}

  uv:tool:install:
    desc: "Install a uv tool without building sdists (e.g., task uv:tool:install -- ruff)"
    cmds:
      - uv tool install --no-build {{.CLI_ARGS}}

  uv:dev:
    desc: "Set up development environment"
    cmds:
      - task: uv:sync
      - uv run pre-commit install

  uv:security:
    desc: "Run security scan"
    cmds:
      - uv run pip-audit
      - trivy fs --severity HIGH,CRITICAL .
